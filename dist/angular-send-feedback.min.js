/**
 * Angular feedback directive similar to Google Feedback
 * @version v1.0.2 - 2016-06-02 * @link https://github.com/jacobscarter/angular-feedback
 * @author Jacob Carter <jacob@ieksolutions.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
angular.module("templates-angularsendfeedback",["angularsendfeedback.html"]),angular.module("angularsendfeedback.html",[]).run(["$templateCache",function(a){a.put("angularsendfeedback.html","")}]),angular.module("angular-send-feedback",["templates-angularsendfeedback"]),angular.module("angular-send-feedback").directive("angularFeedback",["$http","$rootScope","$location",function(a,b,c){return{restrict:"EA",replace:!0,transclude:!0,scope:{options:"="},link:function(d){function e(){a.post(i+"/auth",j,l).then(function(a){l.headers.Authorization="Bearer "+a.data.auth_token})}function f(){canDraw=!1,$(document).off("mouseenter mouseleave",".feedback-helper"),$(document).off("mouseup keyup"),$(document).off("mousedown",".feedback-setblackout"),$(document).off("mousedown",".feedback-sethighlight"),$(document).off("mousedown click","#feedback-close"),$(document).off("mousedown","#feedback-canvas"),$(document).off("click","#feedback-highlighter-next"),$(document).off("click","#feedback-highlighter-back"),$(document).off("click","#feedback-welcome-next"),$(document).off("click","#feedback-overview-back"),$(document).off("mouseleave","body"),$(document).off("mouseenter",".feedback-helper"),$(document).off("selectstart dragstart",document),$("#feedback-module").off("click",".feedback-wizard-close,.feedback-close-btn"),$(document).off("click","#feedback-submit"),n.highlightElement&&($(document).off("click","#feedback-canvas"),$(document).off("mousemove","#feedback-canvas")),$('[data-highlighted="true"]').removeAttr("data-highlight-id").removeAttr("data-highlighted"),$("#feedback-module").remove(),$(".feedback-btn").show(),n.onClose.call(this)}function g(a,b){b="undefined"!=typeof b?b:!0,a.clearRect(0,0,$("#feedback-canvas").width(),$("#feedback-canvas").height()),a.fillStyle="rgba(102,102,102,0.5)",a.fillRect(0,0,$("#feedback-canvas").width(),$("#feedback-canvas").height()),$(".feedback-helper").each(function(){"highlight"==$(this).attr("data-type")&&b&&h(a,parseInt($(this).css("left"),10),parseInt($(this).css("top"),10),$(this).width(),$(this).height())}),$(".feedback-helper").each(function(){"highlight"==$(this).attr("data-type")&&a.clearRect(parseInt($(this).css("left"),10),parseInt($(this).css("top"),10),$(this).width(),$(this).height())}),$(".feedback-helper").each(function(){"blackout"==$(this).attr("data-type")&&(a.fillStyle="rgba(0,0,0,1)",a.fillRect(parseInt($(this).css("left"),10),parseInt($(this).css("top"),10),$(this).width(),$(this).height()))})}function h(a,b,c,d,e){a.strokeStyle=n.strokeStyle,a.shadowColor=n.shadowColor,a.shadowOffsetX=n.shadowOffsetX,a.shadowOffsetY=n.shadowOffsetY,a.shadowBlur=n.shadowBlur,a.lineJoin=n.lineJoin,a.lineWidth=n.lineWidth,a.strokeRect(b,c,d,e),a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0,a.lineWidth=1}var i=d.options.taigaUrl,j=d.options.taigaUser,k=d.options.taigaProject,l={headers:{Authorization:void 0,"Content-Type":"application/json","X-Customer-Id":void 0}},m=d.options,n=_.extend({ajaxURL:"",postBrowserInfo:!0,postHTML:!0,postURL:!0,proxy:void 0,letterRendering:!1,initButtonText:"Send feedback",strokeStyle:"black",shadowColor:"black",shadowOffsetX:1,shadowOffsetY:1,shadowBlur:10,lineJoin:"bevel",lineWidth:3,html2canvasURL:"assets/vendor/js/html2canvas/html2canvas.js",feedbackButton:".feedback-btn",showDescriptionModal:!0,isDraggable:!0,onScreenshotTaken:function(){},tpl:{description:'<div id="feedback-welcome"><div class="feedback-logo">Feedback</div><p>Feedback lets you send us suggestions about our products. We welcome problem reports, feature ideas and general comments.</p><p>Start by writing a brief description:</p><textarea id="feedback-note-tmp"></textarea><p>Next we\'ll let you identify areas of the page related to your description.</p><button id="feedback-welcome-next" class="feedback-next-btn feedback-btn-gray">Next</button><div id="feedback-welcome-error">Please enter a description.</div><div class="feedback-wizard-close"></div></div>',highlighter:'<div id="feedback-highlighter"><div class="feedback-logo">Feedback</div><p>Click and drag on the page to help us better understand your feedback. You can move this dialog if it\'s in the way.</p><button class="feedback-sethighlight feedback-active"><div class="ico"></div><span>Highlight</span></button><label>Highlight areas relevant to your feedback.</label><button class="feedback-setblackout"><div class="ico"></div><span>Black out</span></button><label class="lower">Black out any personal information.</label><div class="feedback-buttons"><button id="feedback-highlighter-next" class="feedback-next-btn feedback-btn-gray">Next</button><button id="feedback-highlighter-back" class="feedback-back-btn feedback-btn-gray">Back</button></div><div class="feedback-wizard-close"></div></div>',overview:'<div id="feedback-overview"><div class="feedback-logo">Feedback</div><div id="feedback-overview-description"><div id="feedback-overview-description-text"><h3>Subject</h3><h3>Description</h3><h3 class="feedback-additional">Additional info</h3><div id="feedback-additional-none"><span>None</span></div><div id="feedback-browser-info"><span>Browser Info</span></div><div id="feedback-page-info"><span>Page Info</span></div><div id="feedback-page-structure"><span>Page Structure</span></div></div></div><div class="feedback-buttons"><button id="feedback-submit" class="feedback-submit-btn feedback-btn-blue">Submit</button><button id="feedback-overview-back" class="feedback-back-btn feedback-btn-gray">Back</button></div><div id="feedback-overview-error">Please enter a description.</div><div class="feedback-wizard-close"></div></div>',submitSuccess:'<div id="feedback-submit-success"><div class="feedback-logo">Feedback</div><p>Thank you for your feedback. We value every piece of feedback we receive.</p><p>We cannot respond individually to every one, but we will use your comments as we strive to improve your experience.</p><button class="feedback-close-btn feedback-btn-blue">OK</button><div class="feedback-wizard-close"></div></div>',submitError:'<div id="feedback-submit-error"><div class="feedback-logo">Feedback</div><p>Sadly an error occured while sending your feedback. Please try again.</p><button class="feedback-close-btn feedback-btn-blue">OK</button><div class="feedback-wizard-close"></div></div>'},onClose:function(){},screenshotStroke:!0,highlightElement:!0,initialBox:!1},m),o=!!window.HTMLCanvasElement,p=".feedback-btn"==n.feedbackButton,q=!1;o&&(p&&$("body").append('<button class="feedback-btn" ng-click="vm.init()" style="position: fixed; bottom: 0px; right:0px; z-index: 999; transform: rotate(-45deg) translateY(40px) translateX(25px);font-size: 35px; width: 140px;height: 65px;"><i class="fa fa-fw fa-bug"></i></button>'),$(document).on("click",n.feedbackButton,function(){e(),p&&$(this).hide(),q||$.getScript(n.html2canvasURL,function(){q=!0});var d=!1,j="",m=$(document).height(),o=$(document).width(),r='<div id="feedback-module">';n.initialBox&&(r+=n.tpl.description),r+=n.tpl.highlighter+n.tpl.overview+'<canvas id="feedback-canvas"></canvas><div id="feedback-helpers"></div><input id="feedback-note" name="feedback-note" type="hidden"></div>',$("body").append(r),moduleStyle={position:"absolute",left:"0px",top:"0px"},canvasAttr={width:o,height:m},$("#feedback-module").css(moduleStyle),$("#feedback-canvas").attr(canvasAttr).css("z-index","30000"),n.initialBox||($("#feedback-highlighter-back").remove(),d=!0,$("#feedback-canvas").css("cursor","crosshair"),$("#feedback-helpers").show(),$("#feedback-welcome").hide(),$("#feedback-highlighter").show()),n.isDraggable&&$("#feedback-highlighter").on("mousedown",function(a){var b=$(this).addClass("feedback-draggable"),c=b.outerHeight(),d=b.outerWidth(),e=b.offset().top+c-a.pageY,f=b.offset().left+d-a.pageX;b.css("z-index",4e4).parents().on("mousemove",function(a){_top=a.pageY+e-c,_left=a.pageX+f-d,_bottom=c-a.pageY,_right=d-a.pageX,_left<0&&(_left=0),_top<0&&(_top=0),_right>$(window).width()&&(_left=$(window).width()-d),_left>$(window).width()-d&&(_left=$(window).width()-d),_bottom>$(document).height()&&(_top=$(document).height()-c),_top>$(document).height()-c&&(_top=$(document).height()-c),$(".feedback-draggable").offset({top:_top,left:_left}).on("mouseup",function(){$(this).removeClass("feedback-draggable")})}),a.preventDefault()}).on("mouseup",function(){$(this).removeClass("feedback-draggable"),$(this).parents().off("mousemove mousedown")});var s=$("#feedback-canvas")[0].getContext("2d");if(s.fillStyle="rgba(102,102,102,0.5)",s.fillRect(0,0,$("#feedback-canvas").width(),$("#feedback-canvas").height()),rect={},drag=!1,highlight=1,post={},n.postBrowserInfo&&(post.browser={},post.browser.appCodeName=navigator.appCodeName,post.browser.appName=navigator.appName,post.browser.appVersion=navigator.appVersion,post.browser.cookieEnabled=navigator.cookieEnabled,post.browser.onLine=navigator.onLine,post.browser.platform=navigator.platform,post.browser.userAgent=navigator.userAgent,post.browser.plugins=[],$.each(navigator.plugins,function(a){post.browser.plugins.push(navigator.plugins[a].name)}),$("#feedback-browser-info").show()),n.postURL&&(post.url=document.URL,$("#feedback-page-info").show()),n.postHTML&&(post.html=$("html").html(),$("#feedback-page-structure").show()),n.postBrowserInfo||n.postURL||n.postHTML||$("#feedback-additional-none").show(),$(document).on("mousedown","#feedback-canvas",function(a){d&&(rect.startX=a.pageX-$(this).offset().left,rect.startY=a.pageY-$(this).offset().top,rect.w=0,rect.h=0,drag=!0)}),$(document).on("mouseup",function(){if(d){drag=!1;var a=rect.startY,b=rect.startX,c=rect.w,e=rect.h;if(dtype="highlight",0==c||0==e)return;0>c&&(b+=c,c*=-1),0>e&&(a+=e,e*=-1),a+e>$(document).height()&&(e=$(document).height()-a),b+c>$(document).width()&&(c=$(document).width()-b),0==highlight&&(dtype="blackout"),$("#feedback-helpers").append('<div class="feedback-helper" data-type="'+dtype+'" data-time="'+Date.now()+'" style="position:absolute;top:'+a+"px;left:"+b+"px;width:"+c+"px;height:"+e+'px;z-index:30000;"></div>'),g(s),rect.w=0}}),$(document).on("mousemove",function(a){d&&drag&&($("#feedback-highlighter").css("cursor","default"),rect.w=a.pageX-$("#feedback-canvas").offset().left-rect.startX,rect.h=a.pageY-$("#feedback-canvas").offset().top-rect.startY,s.clearRect(0,0,$("#feedback-canvas").width(),$("#feedback-canvas").height()),s.fillStyle="rgba(102,102,102,0.5)",s.fillRect(0,0,$("#feedback-canvas").width(),$("#feedback-canvas").height()),$(".feedback-helper").each(function(){"highlight"==$(this).attr("data-type")&&h(s,parseInt($(this).css("left"),10),parseInt($(this).css("top"),10),$(this).width(),$(this).height())}),1==highlight&&(h(s,rect.startX,rect.startY,rect.w,rect.h),s.clearRect(rect.startX,rect.startY,rect.w,rect.h)),$(".feedback-helper").each(function(){"highlight"==$(this).attr("data-type")&&s.clearRect(parseInt($(this).css("left"),10),parseInt($(this).css("top"),10),$(this).width(),$(this).height())}),$(".feedback-helper").each(function(){"blackout"==$(this).attr("data-type")&&(s.fillStyle="rgba(0,0,0,1)",s.fillRect(parseInt($(this).css("left"),10),parseInt($(this).css("top"),10),$(this).width(),$(this).height()))}),0==highlight&&(s.fillStyle="rgba(0,0,0,0.5)",s.fillRect(rect.startX,rect.startY,rect.w,rect.h)))}),n.highlightElement){var t=[],u=[],v=0;$(document).on("mousemove click","#feedback-canvas",function(a){if(d){g(s),u=[],$("#feedback-canvas").css("cursor","crosshair"),$("* :not(body,script,iframe,div,section,.feedback-btn,#feedback-module *)").each(function(){"true"!==$(this).attr("data-highlighted")&&a.pageX>$(this).offset().left&&a.pageX<$(this).offset().left+$(this).width()&&a.pageY>$(this).offset().top+parseInt($(this).css("padding-top"),10)&&a.pageY<$(this).offset().top+$(this).height()+parseInt($(this).css("padding-top"),10)&&u.push($(this))});var b=u[u.length-1];if(b&&!drag){$("#feedback-canvas").css("cursor","pointer");var c=b.offset().left-2,e=b.offset().top-2,f=b.width()+parseInt(b.css("padding-left"),10)+parseInt(b.css("padding-right"),10)+6,i=b.height()+parseInt(b.css("padding-top"),10)+parseInt(b.css("padding-bottom"),10)+6;1==highlight&&(h(s,c,e,f,i),s.clearRect(c,e,f,i),dtype="highlight"),$(".feedback-helper").each(function(){"highlight"==$(this).attr("data-type")&&s.clearRect(parseInt($(this).css("left"),10),parseInt($(this).css("top"),10),$(this).width(),$(this).height())}),0==highlight&&(dtype="blackout",s.fillStyle="rgba(0,0,0,0.5)",s.fillRect(c,e,f,i)),$(".feedback-helper").each(function(){"blackout"==$(this).attr("data-type")&&(s.fillStyle="rgba(0,0,0,1)",s.fillRect(parseInt($(this).css("left"),10),parseInt($(this).css("top"),10),$(this).width(),$(this).height()))}),"click"==a.type&&a.pageX==rect.startX&&a.pageY==rect.startY&&($("#feedback-helpers").append('<div class="feedback-helper" data-highlight-id="'+v+'" data-type="'+dtype+'" data-time="'+Date.now()+'" style="position:absolute;top:'+e+"px;left:"+c+"px;width:"+f+"px;height:"+i+'px;z-index:30000;"></div>'),t.push(v),++v,g(s))}}})}$(document).on("mouseleave","body,#feedback-canvas",function(){g(s)}),$(document).on("mouseenter",".feedback-helper",function(){g(s)}),$(document).on("click","#feedback-welcome-next",function(){$("#feedback-note").val().length>0?(d=!0,$("#feedback-canvas").css("cursor","crosshair"),$("#feedback-helpers").show(),$("#feedback-welcome").hide(),$("#feedback-highlighter").show()):$("#feedback-welcome-error").show()}),$(document).on("mouseenter mouseleave",".feedback-helper",function(a){drag||(rect.w=0,rect.h=0,"mouseenter"===a.type?($(this).css("z-index","30001"),$(this).append('<div class="feedback-helper-inner" style="width:'+($(this).width()-2)+"px;height:"+($(this).height()-2)+'px;position:absolute;margin:1px;"></div>'),$(this).append('<div id="feedback-close"></div>'),$(this).find("#feedback-close").css({top:-1*($(this).find("#feedback-close").height()/2)+"px",left:$(this).width()-$(this).find("#feedback-close").width()/2+"px"}),"blackout"==$(this).attr("data-type")&&(s.clearRect(0,0,$("#feedback-canvas").width(),$("#feedback-canvas").height()),s.fillStyle="rgba(102,102,102,0.5)",s.fillRect(0,0,$("#feedback-canvas").width(),$("#feedback-canvas").height()),$(".feedback-helper").each(function(){"highlight"==$(this).attr("data-type")&&h(s,parseInt($(this).css("left"),10),parseInt($(this).css("top"),10),$(this).width(),$(this).height())}),$(".feedback-helper").each(function(){"highlight"==$(this).attr("data-type")&&s.clearRect(parseInt($(this).css("left"),10),parseInt($(this).css("top"),10),$(this).width(),$(this).height())}),s.clearRect(parseInt($(this).css("left"),10),parseInt($(this).css("top"),10),$(this).width(),$(this).height()),s.fillStyle="rgba(0,0,0,0.75)",s.fillRect(parseInt($(this).css("left"),10),parseInt($(this).css("top"),10),$(this).width(),$(this).height()),ignore=$(this).attr("data-time"),$(".feedback-helper").each(function(){return $(this).attr("data-time")==ignore?!0:void("blackout"==$(this).attr("data-type")&&(s.fillStyle="rgba(0,0,0,1)",s.fillRect(parseInt($(this).css("left"),10),parseInt($(this).css("top"),10),$(this).width(),$(this).height())))}))):($(this).css("z-index","30000"),$(this).children().remove(),"blackout"==$(this).attr("data-type")&&g(s)))}),$(document).on("click","#feedback-close",function(){if(n.highlightElement&&$(this).parent().attr("data-highlight-id"))var a=$(this).parent().attr("data-highlight-id");$(this).parent().remove(),n.highlightElement&&a&&$('[data-highlight-id="'+a+'"]').removeAttr("data-highlighted").removeAttr("data-highlight-id"),g(s)}),$("#feedback-module").on("click",".feedback-wizard-close,.feedback-close-btn",function(){f()}),$(document).on("keyup",function(a){27==a.keyCode&&f()}),$(document).on("selectstart dragstart",document,function(a){a.preventDefault()}),$(document).on("click","#feedback-highlighter-back",function(){d=!1,$("#feedback-canvas").css("cursor","default"),$("#feedback-helpers").hide(),$("#feedback-highlighter").hide(),$("#feedback-welcome-error").hide(),$("#feedback-welcome").show()}),$(document).on("mousedown",".feedback-sethighlight",function(){highlight=1,$(this).addClass("feedback-active"),$(".feedback-setblackout").removeClass("feedback-active")}),$(document).on("mousedown",".feedback-setblackout",function(){highlight=0,$(this).addClass("feedback-active"),$(".feedback-sethighlight").removeClass("feedback-active")}),$(document).on("click","#feedback-highlighter-next",function(){d=!1,$("#feedback-canvas").css("cursor","default");var a=$(document).scrollTop(),b=$(window).height();$("#feedback-helpers").hide(),$("#feedback-highlighter").hide(),n.screenshotStroke||g(s,!1),html2canvas($("body"),{onrendered:function(c){n.screenshotStroke||g(s),_canvas=$('<canvas id="feedback-canvas-tmp" width="'+o+'" height="'+b+'"/>').hide().appendTo("body"),_ctx=_canvas.get(0).getContext("2d"),_ctx.drawImage(c,0,a,o,b,0,0,o,b),j=_canvas.get(0).toDataURL(),$(document).scrollTop(a),post.img=j,n.onScreenshotTaken(post.img),n.showDescriptionModal?($("#feedback-canvas-tmp").remove(),$("#feedback-overview").show(),$("#feedback-overview-description-text>textarea").remove(),$("#feedback-overview-screenshot>img").remove(),$('<textarea id="feedback-overview-subject"> </textarea>').insertAfter("#feedback-overview-description-text h3:eq(0)"),$('<textarea id="feedback-overview-note">'+$("#feedback-note").val()+"</textarea>").insertAfter("#feedback-overview-description-text h3:eq(1)"),$("#feedback-overview-screenshot").append('<img class="feedback-screenshot" src="'+j+'" />')):($("#feedback-module").remove(),f(),_canvas.remove())},proxy:n.proxy,letterRendering:n.letterRendering})}),$(document).on("click","#feedback-overview-back",function(a){d=!0,$("#feedback-canvas").css("cursor","crosshair"),$("#feedback-overview").hide(),$("#feedback-helpers").show(),$("#feedback-highlighter").show(),$("#feedback-overview-error").hide()}),$(document).on("keyup","#feedback-note-tmp,#feedback-note-subject,#feedback-overview-note,#feedback-overview-subject",function(a){var b,c;"feedback-note-tmp"===a.target.id?(b=$("#feedback-note-tmp").val(),c=$("#feedback-overview-subject").val()):(b=$("#feedback-overview-note").val(),c=$("#feedback-overview-subject").val(),$("#feedback-note-tmp").val(b),$("#feedback-subject-tmp").val(c)),$("#feedback-note").val(b),$("#feedback-subject").val(c)}),$(document).on("click","#feedback-submit",function(){function e(a){for(var b=a.attached_file.slice(a.attached_file.indexOf(",")+1),c=atob(b),d=new Array(c.length),e=0;e<c.length;e++)d[e]=c.charCodeAt(e);var f=new Uint8Array(d),g=new Blob([f],{type:"image/png,base64"}),h=new File([g],"screenshot.png"),j=new FormData;j.append("attached_file",h),j.append("object_id",a.object_id),j.append("project",a.project),$.ajax({beforeSend:function(a){a.setRequestHeader("Authorization",l.headers.Authorization)},url:i+"/issues/attachments",data:j,processData:!1,contentType:!1,type:"POST",success:function(a){$("#feedback-module").append(n.tpl.submitSuccess)}})}function f(d){d.description=d.description+" ||| Informacje zalogowanym użytkowniku - id: "+b.user.id+", email: "+b.user.email,d.description=d.description+" ||| Adres Url: "+c.absUrl(),a({method:"POST",url:i+"/issues",headers:l.headers,data:d}).then(function(a){var b={object_id:a.data.id,project:a.data.project,attached_file:j};e(b)},function(a){$("#feedback-module").append(n.tpl.submitError)})}d=!1,$("#feedback-note").val().length>0?($("#feedback-submit-success,#feedback-submit-error").remove(),$("#feedback-overview").hide(),f({project:k,subject:$("#feedback-overview-subject").val(),description:$("#feedback-note").val()})):$("#feedback-overview-error").show()})}))}}}]);